---
title: "R shinydashboard 구현기"
output: ioslides_presentation
widescreen: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(DT)
library(highcharter)
library(data.table)
library(plyr)
library(dplyr)
library("dplyr")
library("purrr")

hcoptslang <- getOption("highcharter.lang")
hcoptslang$thousandsSep <- ","
options(highcharter.lang = hcoptslang)
hcoptslang$numericSymbols <-c( "k", "M", "B" ,"T", "P" ,"E")
options(highcharter.lang = hcoptslang)


```

## R shinydashboard 구현 필요성 

첫 직장이 게임회사였으며, 게임의 특성상 이벤트가 발생하게 되면 해당 이벤트관련 효과분석을 주로 수행해야하는 일이 많았었습니다.

```{r, out.width='50%', fig.align='center', fig.cap=''}
knitr::include_graphics('game_update.png')
```

## 정기적인 리포트의 시간할애

간혹 이벤트 분석을 하다보면, 제한된 시간은 짧은반면 요구사항은 많은 경우가 있습니다. 물론, SQL 로 처리하면 될 문제이긴하지만 이부분이 여간 귀찮은게 아니더라구요.

```{r, out.width='50%', fig.align='center', fig.cap=''}
knitr::include_graphics('typing_d.png')
```


## 그래서 알게 된 것이 Shiny!

          
```{r, out.width='50%', fig.align='center', fig.cap=''}
knitr::include_graphics('shiny.png')
```

## Shiny 구현의 한계

그러나 shiny를 활용하면 구현은 쉬우나 무엇인가 저의 개인적인 만족을 채울순 없었던 것 같습니다.

```{r, out.width='50%', fig.align='center', fig.cap=''}
knitr::include_graphics('shiny_ex.png')
```

## Shiny dashboard의 발견

그러던 중 Admin LTE 기반으로 구현이 가능한 패키지를 알게되었습니다. 

```{r, out.width='50%', fig.align='center', fig.cap=''}
knitr::include_graphics('shinydashboard.png')
```


## 시각화의 Interactive

하지만 단순 대시보드를 만든다고 한들 시각화도 동적으로 그려보는건 어떨까 하는 개인적인 욕심이 있었고, 해당 부분에 대한 예제는 다음과 같습니다.


## Barchart 

```{r echo=FALSE,message=FALSE,warning=FALSE, fig.cap='지역별 수입' }
data = data.frame(state.x77,region = state.region,city_name = row.names(state.x77))

data_1 = ddply(data,.(region,city_name),summarise,mean=mean(Income),sum_income=sum(Income))

data_2 = ddply(data,.(region),summarise,mean=mean(Income),sum_income=sum(Income))

  hchart(data_2, "column", hcaes(x = region, y = sum_income)) %>%
    hc_yAxis(title = list(text = "total_income")) %>%
    hc_plotOptions(column = list(
     dataLabels = list(enabled = TRUE)
    ))

```



## box-plot

```{r echo=FALSE,message=FALSE,warning=FALSE, fig.cap='' }

data = data.frame(state.x77,region = state.region,city_name = data$city_name)

hcboxplot(x = data$Income, var = data$region,
          name = "Length", color = "#2980b9")  %>% 
  hc_chart(type = "column")

```


## scatter plot

```{r echo=FALSE,message=FALSE,warning=FALSE, fig.cap='' }

data = data.frame(state.x77,region = state.region,city_name = data$city_name)


hchart(data, "scatter", hcaes(x = HS.Grad, y = Income, group = region))

```


## bubble plot

```{r echo=FALSE,message=FALSE,warning=FALSE, fig.cap='' }
data = data.frame(state.x77,region = state.region,city_name = data$city_name)

hchart(data, "scatter", hcaes(x = HS.Grad, y = Income,size = Life.Exp, group = region)) 


```


## map plot

```{r echo=FALSE,message=FALSE,warning=FALSE, fig.cap='' }
data = data.frame(state.x77,region = state.region,city_name = data$city_name)

hcmap("countries/us/us-all", data = data, value = "Income",
      joinBy = c("name", "city_name"), name = "Income",
      dataLabels = list(enabled = TRUE, format = '{point.name}'),
      borderColor = "#FAFAFA", borderWidth = 0.1,
      tooltip = list(valueDecimals = 2, valuePrefix = "$", valueSuffix = " USD")) 

```




## DT Table


```{r out.width='25%', fig.cap='활용라이브러리 : DT' }

DT::datatable(data
            ,extensions = 'Buttons', options = list(
                    dom = 'Bfrtip',
                    buttons = list('copy', 'print', 'csv', 'excel', 'pdf'),
                    pageLength = 8, 
                    scrollY = "300px"
                    
                  )
)


```


## Drill Down


```{r echo=FALSE,message=FALSE,warning=FALSE}


data = data.frame(state.x77,region = state.region,city_name = row.names(state.x77))

data_1 = ddply(data,.(region,city_name),summarise,mean=mean(Income),sum_income=sum(Income))

data_2 = ddply(data,.(region),summarise,mean=mean(Income),sum_income=sum(Income))



df <- data_frame(
  name = data_2$region,
  y = data_2$sum_income,
  drilldown = tolower(data_2$region)
)


ds <- list_parse(df)
names(ds) <- NULL

hc <- highchart() %>% 
  hc_chart(type = "column") %>% 
  hc_title(text = "Basic drilldown") %>% 
  hc_xAxis(type = "category") %>% 
  hc_legend(enabled = FALSE) %>% 
  hc_plotOptions(
    series = list(
      boderWidth = 0,
      dataLabels = list(enabled = TRUE)
    )
  ) %>% 
  hc_add_series(
    name = "Things",
    colorByPoint = TRUE,
    data = ds
  )

df_1 <- data_frame(
  name = as_vector(subset(data_1,region == "Northeast",city_name)),
  value = as_vector(subset(data_1,region == "Northeast",sum_income))
)

df_2 <- data_frame(
  name = as_vector(subset(data_1,region == "South",city_name)),
  value = as_vector(subset(data_1,region == "South",sum_income))
)

df_3 <- data_frame(
  name = as_vector(subset(data_1,region == "North Central",city_name)),
  value = as_vector(subset(data_1,region == "North Central",sum_income))
)

df_4 <- data_frame(
  name = as_vector(subset(data_1,region == "West",city_name)),
  value = as_vector(subset(data_1,region == "West",sum_income))
)

second_el_to_numeric <- function(ls){
  
  map(ls, function(x){
    x[[2]] <- as.numeric(x[[2]])
    x
  })
  
}

df_1 <- second_el_to_numeric(list_parse2(df_1))
df_2 <- second_el_to_numeric(list_parse2(df_2))
df_3 <- second_el_to_numeric(list_parse2(df_3))
df_4 <- second_el_to_numeric(list_parse2(df_4))


hc <- hc %>% 
  hc_drilldown(
    allowPointDrilldown = TRUE,
    series = list(
      list(
        id = "northeast",
        data = df_1
      ),
      list(
        id = "south",
        data = df_2
      ),
      list(
        id = "north central",
        data = df_3
      ),
      list(
        id = "west",
        data = df_4
      )
    )
  )

hc  
```

